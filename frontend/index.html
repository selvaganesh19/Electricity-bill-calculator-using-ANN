<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Electricity Bill Calculator - TNEB Tariff</title>
  <meta name="description" content="Calculate your monthly electricity consumption with TNEB tariff rates." />
  <meta name="theme-color" content="#7c3aed" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="icon" href="data:," />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #7c3aed; --primary-light: #a855f7; --blue: #2563eb;
      --green: #059669; --green-dark: #065f46; --orange: #b45309; --red: #dc2626;
      --g50: #f9fafb; --g100: #f3f4f6; --g200: #e5e7eb; --g300: #d1d5db;
      --g400: #9ca3af; --g500: #6b7280; --g700: #374151; --g900: #1f2937;
      --r: 12px; --rl: 16px; --rx: 20px;
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background: linear-gradient(180deg, #ede4ff 0%, #f5f0ff 25%, #eef8ff 60%, #f0fdf4 100%);
      min-height: 100vh; color: var(--g900); line-height: 1.5;
    }
    .ctr { max-width: 1180px; margin: 0 auto; padding: 28px 16px; }
    @media (min-width: 640px) { .ctr { padding: 36px 24px; } }

    /* HEADER */
    .hdr { text-align: center; margin-bottom: 28px; }
    .hdr h1 {
      font-size: clamp(1.6rem, 5vw, 2.8rem); font-weight: 900;
      background: linear-gradient(135deg, #7c3aed 0%, #a855f7 40%, #2563eb 100%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; letter-spacing: -0.025em;
    }
    .hdr .sub { margin-top: 10px; color: var(--g500); font-size: 1rem; }
    .badges { margin-top: 14px; display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; }
    .bdg {
      display: inline-flex; align-items: center; padding: 4px 14px; border-radius: 999px;
      font-size: 0.75rem; font-weight: 600; border: 1.5px solid transparent;
    }
    .bdg-g { background: #dcfce7; color: #15803d; } .bdg-b { background: #eff6ff; color: #2563eb; border-color: #93c5fd; }
    .bdg-p { background: #f5f0ff; color: #7c3aed; border-color: #c4b5fd; }
    .bdg-sm { font-size: 0.7rem; padding: 2px 10px; background: transparent; border-color: var(--g200); color: var(--g500); }

    /* TABS */
    .tabs {
      display: grid; grid-template-columns: repeat(4, 1fr);
      background: #fff; border-radius: var(--rl); padding: 5px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 24px;
    }
    .tbtn {
      display: flex; align-items: center; justify-content: center; gap: 6px;
      padding: 10px 4px; border: none; border-radius: var(--r);
      background: transparent; color: var(--g500); cursor: pointer;
      font-size: 0.85rem; font-weight: 500; transition: all .2s; font-family: inherit;
    }
    .tbtn:hover { background: #f5f0ff; color: var(--primary); }
    .tbtn.on { background: #f5f0ff; color: var(--primary); box-shadow: 0 1px 4px rgba(124,58,237,.12); font-weight: 600; }
    .tbtn svg { width: 18px; height: 18px; flex-shrink: 0; }
    .tbtn .tl { display: none; }
    @media (min-width: 480px) { .tbtn .tl { display: inline; } }
    .pan { display: none; } .pan.on { display: block; }

    /* CARDS */
    .cd {
      background: #fff; border: 1px solid var(--g200); border-radius: var(--rx);
      padding: 24px; margin-bottom: 20px; transition: box-shadow .2s;
    }
    .cd:hover { box-shadow: 0 4px 20px rgba(0,0,0,.04); }
    .cd-g { border-color: #a7f3d0; background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf9 100%); }
    .cd-b { border-color: #bfdbfe; background: linear-gradient(135deg, #eff6ff 0%, #fafcff 100%); }
    .cd-p { border-color: #ddd6fe; background: linear-gradient(135deg, #f5f0ff 0%, #faf8ff 100%); }
    .cd-y { border-color: #fde68a; background: linear-gradient(135deg, #fffbeb 0%, #fffef7 100%); }
    .cd-r { border-color: #fca5a5; background: linear-gradient(135deg, #fef2f2 0%, #fff 100%); }
    .cd h3 { font-size: 1.1rem; font-weight: 700; } .cd .ds { margin-top: 4px; font-size: 0.85rem; color: var(--g500); }

    /* GRIDS */
    .g2 { display: grid; gap: 20px; } @media (min-width: 768px) { .g2 { grid-template-columns: 1fr 1fr; } }
    .g4 { display: grid; gap: 14px; grid-template-columns: 1fr 1fr; } @media (min-width: 1024px) { .g4 { grid-template-columns: repeat(4, 1fr); } }
    .gh { display: grid; gap: 10px; grid-template-columns: repeat(2, 1fr); }
    @media (min-width: 640px) { .gh { grid-template-columns: repeat(3, 1fr); } }
    @media (min-width: 1024px) { .gh { grid-template-columns: repeat(6, 1fr); } }
    .s2 { grid-column: 1 / -1; }

    /* HOUSE BUTTONS */
    .hb {
      border: 2px solid var(--g200); background: #fff; border-radius: var(--r);
      padding: 14px 8px; text-align: center; cursor: pointer; transition: all .2s; font-family: inherit;
    }
    .hb:hover { border-color: rgba(124,58,237,.4); background: #faf5ff; transform: translateY(-1px); }
    .hb.on { border-color: var(--primary); background: linear-gradient(135deg, #7c3aed, #a855f7); color: #fff; box-shadow: 0 4px 18px rgba(124,58,237,.25); transform: translateY(-1px); }
    .hb .hn { font-size: 0.85rem; font-weight: 700; } .hb .hi { font-size: 0.7rem; margin-top: 2px; color: var(--g400); }
    .hb.on .hi { color: #e0d4f5; }
    .hb .he { font-size: 1.4rem; margin-bottom: 4px; }

    /* FORM */
    .fr { display: flex; flex-wrap: wrap; gap: 14px; margin-top: 18px; align-items: flex-end; }
    .fg { flex: 1; min-width: 150px; } .fg.sm { flex: 0 0 auto; width: 90px; min-width: 90px; }
    .fg label { display: block; margin-bottom: 5px; font-size: 0.82rem; font-weight: 600; color: var(--g700); }
    select, input[type="number"] {
      width: 100%; padding: 9px 12px; border: 1.5px solid var(--g300); border-radius: 10px;
      font-size: 0.85rem; font-family: inherit; background: #fff; color: var(--g700);
      transition: all .2s; appearance: auto;
    }
    select:focus, input[type="number"]:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(124,58,237,.1); }
    select:disabled { background: var(--g100); color: var(--g400); cursor: not-allowed; }

    /* BUTTONS */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      padding: 10px 24px; border: none; border-radius: 10px;
      font-size: 0.85rem; font-weight: 600; cursor: pointer; font-family: inherit;
      transition: all .2s; white-space: nowrap;
    }
    .btn-g { background: linear-gradient(135deg, #059669, #10b981); color: #fff; box-shadow: 0 2px 8px rgba(5,150,105,.2); }
    .btn-g:hover { box-shadow: 0 4px 14px rgba(5,150,105,.3); transform: translateY(-1px); }
    .btn-g:disabled { background: var(--g300); box-shadow: none; cursor: not-allowed; transform: none; }
    .btn-r { background: transparent; color: var(--red); padding: 8px; border: none; border-radius: 8px; cursor: pointer; font-family: inherit; }
    .btn-r:hover { background: #fef2f2; }

    /* APPLIANCE LIST */
    .ai {
      display: flex; align-items: center; gap: 14px;
      border: 1px solid var(--g200); border-radius: var(--r); padding: 14px 16px;
      background: linear-gradient(90deg, var(--g50), #fff); transition: all .2s;
    }
    .ai:hover { box-shadow: 0 4px 12px rgba(0,0,0,.05); transform: translateY(-1px); }
    .ai + .ai { margin-top: 10px; }
    .aicon {
      width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;
      background: linear-gradient(135deg, #ecfdf5, #d1fae5); border-radius: 12px; font-size: 1.3rem; flex-shrink: 0;
    }
    .ainfo { flex: 1; min-width: 0; } .ainfo .nm { font-weight: 600; color: var(--g900); font-size: 0.88rem; }
    .ainfo .tp { font-size: 0.72rem; color: var(--g500); }
    .ast { text-align: center; } .ast .v { font-size: 0.85rem; font-weight: 600; color: var(--g700); }
    .ast .l { font-size: 0.66rem; color: var(--g400); text-transform: uppercase; letter-spacing: .3px; }
    .ast.gv .v { color: var(--green); font-weight: 700; }
    @media (max-width: 600px) { .ast.hm { display: none; } }

    /* STAT CARDS */
    .sc { border-radius: var(--rx); padding: 20px; transition: transform .2s; }
    .sc:hover { transform: translateY(-2px); }
    .sc .tp { display: flex; align-items: center; justify-content: space-between; }
    .sc .lb { font-size: 0.82rem; font-weight: 600; } .sc .vl { margin-top: 8px; font-size: 1.4rem; font-weight: 800; color: var(--g900); }
    .sc .sb { margin-top: 2px; font-size: 0.82rem; color: var(--g500); }
    .sc .mc { margin-top: 2px; font-size: 0.72rem; font-weight: 500; }

    /* TABLE */
    .tw { margin-top: 16px; border: 1px solid var(--g200); border-radius: var(--r); overflow: hidden; }
    .tt { width: 100%; border-collapse: collapse; }
    .tt thead tr { background: linear-gradient(90deg, #7c3aed, #a855f7); color: #fff; }
    .tt th { padding: 12px 16px; text-align: left; font-size: 0.82rem; font-weight: 600; }
    .tt th:last-child { text-align: right; }
    .tt td { padding: 11px 16px; font-size: 0.85rem; border-bottom: 1px solid var(--g100); }
    .tt td:last-child { text-align: right; font-weight: 700; }
    .tt tr.hl { background: #ecfdf5; } .tt tr.hl td:last-child { color: var(--green); }
    .tt tr:hover:not(:first-child) { background: #faf5ff; }

    /* BILL TOTAL BARS */
    .btb {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-radius: var(--r); color: #fff; margin-top: 10px;
    }
    .btb .t { font-size: 0.95rem; font-weight: 600; } .btb .v { font-size: 1.2rem; font-weight: 800; }
    .btb-p { background: linear-gradient(90deg, #7c3aed, #a855f7); box-shadow: 0 4px 15px rgba(124,58,237,.2); }
    .btb-g { background: linear-gradient(90deg, #059669, #10b981); box-shadow: 0 4px 15px rgba(5,150,105,.2); }

    /* PROGRESS BAR */
    .pt { height: 8px; background: var(--g100); border-radius: 999px; overflow: hidden; margin-top: 6px; }
    .pf { height: 100%; border-radius: 999px; background: linear-gradient(90deg, #7c3aed, #a855f7); transition: width .5s ease; }

    /* SLAB ROWS */
    .sr { display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border: 1px solid var(--g200); border-radius: 10px; background: #fff; }
    .sr + .sr { margin-top: 8px; }
    .sr .sn { font-size: 0.85rem; font-weight: 500; color: var(--g700); } .sr .sd { font-size: 0.72rem; color: var(--g400); margin-left: 8px; }
    .sr .sa { font-size: 0.85rem; font-weight: 700; } .sr .sa.fr { color: var(--green); }

    /* ALERTS */
    .alt { display: flex; gap: 14px; padding: 16px; border-radius: var(--r); border: 1.5px solid; }
    .alt + .alt { margin-top: 12px; }
    .alt-i { flex-shrink: 0; margin-top: 2px; font-size: 1.2rem; }
    .alt-t { font-weight: 700; font-size: 0.9rem; } .alt-m { font-size: 0.85rem; color: var(--g500); margin-top: 4px; line-height: 1.5; }
    .alt-d { border-color: #fca5a5; background: linear-gradient(135deg, #fef2f2, #fff); } .alt-d .alt-i, .alt-d .alt-t { color: #991b1b; }
    .alt-w { border-color: #fde68a; background: linear-gradient(135deg, #fffbeb, #fff); } .alt-w .alt-i, .alt-w .alt-t { color: #92400e; }
    .alt-s { border-color: #a7f3d0; background: linear-gradient(135deg, #ecfdf5, #fff); } .alt-s .alt-i, .alt-s .alt-t { color: #065f46; }
    .alt-inf { border-color: #bfdbfe; background: linear-gradient(135deg, #eff6ff, #fff); } .alt-inf .alt-i, .alt-inf .alt-t { color: #1e3a5f; }

    /* QUICK STATS */
    .qg { display: grid; gap: 14px; grid-template-columns: repeat(3, 1fr); margin-top: 16px; }
    @media (max-width: 640px) { .qg { grid-template-columns: 1fr; } }
    .qb { background: #fff; padding: 18px; border-radius: var(--r); box-shadow: 0 2px 8px rgba(0,0,0,.04); border: 1px solid var(--g100); }
    .qb .ql { font-size: 0.72rem; font-weight: 600; color: var(--g500); text-transform: uppercase; letter-spacing: .5px; }
    .qb .qv { font-size: 1.3rem; font-weight: 800; margin-top: 6px; color: var(--g900); }

    /* TIPS */
    .tg { display: grid; gap: 20px; margin-top: 20px; } @media (min-width: 768px) { .tg { grid-template-columns: 1fr 1fr; } }
    .ts .st { display: flex; align-items: center; gap: 8px; font-weight: 700; color: #1e3a5f; margin-bottom: 10px; font-size: 0.92rem; }
    .ti { display: flex; align-items: flex-start; gap: 10px; padding: 10px 14px; border: 1px solid var(--g200); border-radius: 10px; background: #fff; transition: all .2s; }
    .ti:hover { border-color: #a7f3d0; background: #f0fdf4; }
    .ti + .ti { margin-top: 6px; }
    .td { width: 8px; height: 8px; border-radius: 50%; background: linear-gradient(135deg, #10b981, #34d399); flex-shrink: 0; margin-top: 6px; }
    .tx { font-size: 0.85rem; color: var(--g700); }

    /* SETTINGS */
    .sl { font-size: 0.85rem; font-weight: 700; margin-bottom: 8px; display: block; }
    .sh { font-size: 0.72rem; color: var(--g400); margin-top: 5px; line-height: 1.4; }
    .ib { margin-top: 14px; padding: 14px; border-radius: 10px; background: linear-gradient(135deg, #eff6ff, #f0f9ff); border: 1px solid #bfdbfe; }
    .ib p { font-size: 0.85rem; color: #1e40af; font-weight: 500; } .ib .sm { font-size: 0.75rem; color: #3b82f6; margin-top: 4px; font-weight: 400; }
    .gy { display: flex; flex-direction: column; gap: 22px; }

    /* FOOTER */
    .ft { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--g200); text-align: center; }
    .ft p { font-size: 0.72rem; color: var(--g400); margin-top: 3px; }

    /* ANIMATIONS */
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .pan.on { animation: fadeIn .3s ease; }
    @keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.05); } }
    .pulse { animation: pulse .6s ease; }

    /* Empty state */
    .empty { text-align: center; padding: 40px 20px; }
    .empty .ei { font-size: 3rem; margin-bottom: 12px; opacity: .6; }
    .empty .et { font-size: 1rem; font-weight: 600; color: var(--g700); }
    .empty .em { font-size: 0.85rem; color: var(--g400); margin-top: 6px; }
  </style>
</head>
<body>
<div class="ctr">
  <!-- HEADER -->
  <header class="hdr">
    <h1>Smart Electricity Bill Calculator</h1>
    <p class="sub">Calculate your monthly electricity consumption with TNEB tariff</p>
    <div class="badges">
      <span class="bdg bdg-g">First 100 units FREE</span>
      <span class="bdg bdg-b">TNEB Approved</span>
      <span class="bdg bdg-p">Seasonal Insights</span>
    </div>
  </header>

  <!-- TABS -->
  <nav class="tabs" role="tablist">
    <button class="tbtn on" onclick="go('appliances')" role="tab" aria-selected="true" id="t-appliances">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>
      <span class="tl">Appliances</span>
    </button>
    <button class="tbtn" onclick="go('settings')" role="tab" aria-selected="false" id="t-settings">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15-.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
      <span class="tl">Settings</span>
    </button>
    <button class="tbtn" onclick="go('summary')" role="tab" aria-selected="false" id="t-summary">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" x2="18" y1="20" y2="10"/><line x1="12" x2="12" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="14"/></svg>
      <span class="tl">Summary</span>
    </button>
    <button class="tbtn" onclick="go('alerts')" role="tab" aria-selected="false" id="t-alerts">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>
      <span class="tl">Alerts</span>
    </button>
  </nav>

  <!-- ============ APPLIANCES TAB ============ -->
  <div class="pan on" id="p-appliances" role="tabpanel">
    <div class="cd cd-p">
      <h3 style="color:#4a1d96;">Select Your House Type</h3>
      <p class="ds" style="color:#7c6a9a;">Choose your house type for better consumption estimates</p>
      <div class="gh" style="margin-top:14px;" id="houseGrid"></div>
    </div>
    <div class="cd cd-g">
      <div style="display:flex;align-items:center;gap:8px;">
        <svg style="color:#059669;" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
        <h3 style="color:#065f46;">Add New Appliance</h3>
      </div>
      <p class="ds">Select appliances, their efficiency ratings, and usage patterns</p>
      <div class="fr">
        <div class="fg"><label>Appliance</label><select id="sA" onchange="onAC()"><option value="">Select appliance</option></select></div>
        <div class="fg"><label>Type</label><select id="sT" disabled><option value="">Select type</option></select></div>
        <div class="fg sm"><label>Qty</label><input type="number" id="iQ" value="1" min="1" max="20"/></div>
        <div class="fg sm" style="width:100px;"><label>Hrs/Day</label><input type="number" id="iH" value="8" min="0.5" max="24" step="0.5"/></div>
        <div><button class="btn btn-g" id="bA" onclick="addA()" disabled>
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
          Add
        </button></div>
      </div>
    </div>
    <div id="alSec" style="display:none;">
      <div class="cd">
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <div><h3>Your Appliances</h3><p class="ds" id="alSum"></p></div>
          <span class="bdg bdg-p" id="alCnt"></span>
        </div>
        <div id="alList" style="margin-top:16px;"></div>
        <div style="margin-top:16px;display:flex;gap:10px;flex-wrap:wrap;">
          <div style="flex:1;padding:14px 18px;border-radius:10px;background:linear-gradient(135deg,#ecfdf5,#d1fae5);border:1px solid #a7f3d0;">
            <div style="font-size:.72rem;font-weight:600;color:#065f46;text-transform:uppercase;letter-spacing:.5px;">Daily Usage</div>
            <div id="alDaily" style="font-size:1.15rem;font-weight:800;color:#059669;margin-top:4px;"></div>
          </div>
          <div style="flex:1;padding:14px 18px;border-radius:10px;background:linear-gradient(135deg,#eff6ff,#dbeafe);border:1px solid #93c5fd;">
            <div style="font-size:.72rem;font-weight:600;color:#1e40af;text-transform:uppercase;letter-spacing:.5px;">Monthly Est.</div>
            <div id="alMonthly" style="font-size:1.15rem;font-weight:800;color:#2563eb;margin-top:4px;"></div>
          </div>
          <div style="flex:1;padding:14px 18px;border-radius:10px;background:linear-gradient(135deg,#f5f0ff,#ede9fe);border:1px solid #c4b5fd;">
            <div style="font-size:.72rem;font-weight:600;color:#5b21b6;text-transform:uppercase;letter-spacing:.5px;">TNEB Bill Est.</div>
            <div id="alBill" style="font-size:1.15rem;font-weight:800;color:#7c3aed;margin-top:4px;"></div>
          </div>
        </div>
      </div>
    </div>
    <div id="alEmpty">
      <div class="cd">
        <div class="empty">
          <div class="ei">&#9889;</div>
          <div class="et">No Appliances Added Yet</div>
          <div class="em">Add your household appliances above to calculate electricity consumption and get your estimated TNEB bill.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ SETTINGS TAB ============ -->
  <div class="pan" id="p-settings" role="tabpanel">
    <div class="g2">
      <div class="cd">
        <h3>Seasonal Settings</h3>
        <p class="ds">Select current season for accurate consumption calculation</p>
        <div style="margin-top:22px;">
          <label class="sl" style="color:#2563eb;">Current Season</label>
          <select id="sS" onchange="onSC()"><option value="">Select season</option></select>
          <div id="sInfo" style="display:none;" class="ib"></div>
        </div>
      </div>
      <div class="cd">
        <h3>Billing Settings</h3>
        <p class="ds">Configure your electricity rate and consumption limits</p>
        <div class="gy" style="margin-top:22px;">
          <div>
            <label class="sl" style="color:#b45309;">Rate per Unit (&#8377;/kWh)</label>
            <input type="number" id="iR" value="5" min="0" step="0.5" onchange="calc()"/>
            <p class="sh">Used for flat-rate calculation (TNEB slab rates are applied separately)</p>
          </div>
          <div>
            <label class="sl" style="color:#2563eb;">Monthly Consumption Limit (kWh)</label>
            <input type="number" id="iL" value="0" min="0" onchange="calc()"/>
            <p class="sh">Set to 0 for no limit. Get alerts when you exceed this limit.</p>
          </div>
        </div>
      </div>
      <div class="cd cd-p s2">
        <h3 style="color:#4a1d96;">TNEB Domestic Tariff Slabs</h3>
        <p class="ds" style="color:#7c6a9a;">Tamil Nadu Electricity Board tariff rates for domestic consumers (Bi-monthly billing)</p>
        <div class="tw">
          <table class="tt">
            <thead><tr><th>Slab</th><th>Units Range</th><th>Rate (&#8377;/Unit)</th></tr></thead>
            <tbody>
              <tr class="hl"><td>Slab 1</td><td>0 - 100 units</td><td>Free</td></tr>
              <tr><td>Slab 2</td><td>101 - 200 units</td><td>&#8377;2.25</td></tr>
              <tr class="hl"><td>Slab 3</td><td>201 - 400 units</td><td>&#8377;4.50</td></tr>
              <tr><td>Slab 4</td><td>401 - 500 units</td><td>&#8377;6.00</td></tr>
              <tr class="hl"><td>Slab 5</td><td>501 - 600 units</td><td>&#8377;8.00</td></tr>
              <tr><td>Slab 6</td><td>601 - 800 units</td><td>&#8377;9.00</td></tr>
              <tr class="hl"><td>Slab 7</td><td>801 - 1000 units</td><td>&#8377;10.00</td></tr>
              <tr><td>Slab 8</td><td>Above 1000 units</td><td>&#8377;11.00</td></tr>
            </tbody>
          </table>
        </div>
        <div style="margin-top:14px;padding:12px 16px;border-radius:10px;background:linear-gradient(135deg,#fffbeb,#fff);border:1px solid #fde68a;">
          <p style="font-size:.82rem;color:#92400e;font-weight:500;">Important: First 100 units are free for domestic consumers. If total consumption exceeds 100 units, all units are charged from Slab 1 rate onwards (no free units).</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ============ SUMMARY TAB ============ -->
  <div class="pan" id="p-summary" role="tabpanel"><div id="sumC"></div></div>

  <!-- ============ ALERTS TAB ============ -->
  <div class="pan" id="p-alerts" role="tabpanel"><div id="altC"></div></div>

  <!-- FOOTER -->
  <footer class="ft">
    <p style="font-weight:500;color:var(--g500);">Smart Electricity Bill Calculator</p>
    <p>TNEB tariff rates based on Tamil Nadu Electricity Board domestic consumer rates.</p>
    <p>Actual bills may vary. This is an estimate based on your inputs.</p>
  </footer>
</div>
<script>
// ============================================================
// DATA
// ============================================================
const SLABS=[
  {mn:0,mx:100,r:0,l:"Free Tier (0-100)"},{mn:101,mx:200,r:2.25,l:"Slab 2 (101-200)"},
  {mn:201,mx:400,r:4.5,l:"Slab 3 (201-400)"},{mn:401,mx:500,r:6,l:"Slab 4 (401-500)"},
  {mn:501,mx:600,r:8,l:"Slab 5 (501-600)"},{mn:601,mx:800,r:9,l:"Slab 6 (601-800)"},
  {mn:801,mx:1000,r:10,l:"Slab 7 (801-1000)"},{mn:1001,mx:1/0,r:11,l:"Slab 8 (1000+)"}
];
const AP=[
  {id:"fan",n:"Fan",e:"üí®",t:[
    {id:"ceiling_reg",n:"Ceiling Fan (Regular)",w:75},{id:"ceiling_bldc",n:"Ceiling Fan (BLDC)",w:30},
    {id:"table",n:"Table Fan",w:50},{id:"exhaust",n:"Exhaust Fan",w:40},{id:"pedestal",n:"Pedestal Fan",w:55}]},
  {id:"light",n:"Light Bulb",e:"üí°",t:[
    {id:"led7",n:"LED Bulb (7W)",w:7},{id:"led12",n:"LED Bulb (12W)",w:12},{id:"led15",n:"LED Bulb (15W)",w:15},
    {id:"cfl15",n:"CFL (15W)",w:15},{id:"cfl23",n:"CFL (23W)",w:23},{id:"inc60",n:"Incandescent (60W)",w:60},
    {id:"inc100",n:"Incandescent (100W)",w:100},{id:"tube36",n:"Tube Light (36W)",w:36},{id:"ledtube",n:"LED Tube (20W)",w:20}]},
  {id:"tv",n:"Television",e:"üì∫",t:[
    {id:"led32",n:'LED TV 32"',w:50},{id:"led43",n:'LED TV 43"',w:80},{id:"led55",n:'LED TV 55"',w:120},
    {id:"led65",n:'LED TV 65"',w:150},{id:"oled55",n:'OLED TV 55"',w:100},{id:"crt",n:"CRT TV (Old)",w:150}]},
  {id:"ac",n:"Air Conditioner",e:"‚ùÑÔ∏è",t:[
    {id:"s1t5",n:"Split 1T (5-Star)",w:900},{id:"s1t3",n:"Split 1T (3-Star)",w:1100},
    {id:"s15t5",n:"Split 1.5T (5-Star)",w:1300},{id:"s15t3",n:"Split 1.5T (3-Star)",w:1600},
    {id:"s2t5",n:"Split 2T (5-Star)",w:1800},{id:"w15t",n:"Window AC 1.5T",w:1800},
    {id:"inv15",n:"Inverter AC 1.5T",w:1000}]},
  {id:"fridge",n:"Refrigerator",e:"üßä",t:[
    {id:"s190",n:"Single Door (190L)",w:80},{id:"d260",n:"Double Door (260L)",w:150},
    {id:"d350",n:"Double Door (350L)",w:200},{id:"sbs",n:"Side by Side (600L)",w:300},
    {id:"mini",n:"Mini Fridge (50L)",w:50},{id:"inv",n:"Inverter Fridge (260L)",w:100}]},
  {id:"wash",n:"Washing Machine",e:"üß∫",t:[
    {id:"semi7",n:"Semi-Auto (7kg)",w:350},{id:"full7",n:"Fully Auto (7kg)",w:500},
    {id:"front7",n:"Front Load (7kg)",w:400},{id:"top8",n:"Top Load (8kg)",w:550}]},
  {id:"geyser",n:"Water Heater / Geyser",e:"üî•",t:[
    {id:"inst3",n:"Instant (3L)",w:3000},{id:"stor15",n:"Storage (15L)",w:2000},
    {id:"stor25",n:"Storage (25L)",w:2500},{id:"solar",n:"Solar Hybrid",w:1500}]},
  {id:"iron",n:"Iron / Press",e:"üëï",t:[
    {id:"dry",n:"Dry Iron",w:750},{id:"steam",n:"Steam Iron",w:1200},{id:"cordless",n:"Cordless Iron",w:1000}]},
  {id:"mixer",n:"Mixer / Grinder",e:"üç≤",t:[
    {id:"mx500",n:"Mixer Grinder (500W)",w:500},{id:"mx750",n:"Mixer Grinder (750W)",w:750},
    {id:"wet",n:"Wet Grinder",w:150},{id:"juicer",n:"Juicer / Blender",w:300}]},
  {id:"micro",n:"Microwave Oven",e:"üçû",t:[
    {id:"solo20",n:"Solo (20L)",w:800},{id:"grill25",n:"Grill (25L)",w:1200},
    {id:"conv28",n:"Convection (28L)",w:1500},{id:"otg25",n:"OTG (25L)",w:1500}]},
  {id:"comp",n:"Computer / Laptop",e:"üíª",t:[
    {id:"laptop",n:"Laptop",w:50},{id:"desktop",n:"Desktop PC",w:200},
    {id:"gaming",n:"Gaming PC",w:500},{id:"monitor",n:'Monitor 24"',w:30}]},
  {id:"pump",n:"Water Motor / Pump",e:"üíß",t:[
    {id:"p05",n:"0.5 HP Motor",w:375},{id:"p1",n:"1 HP Motor",w:750},
    {id:"p15",n:"1.5 HP Motor",w:1100},{id:"sub1",n:"Submersible 1 HP",w:750}]},
  {id:"router",n:"WiFi Router",e:"üì∂",t:[
    {id:"basic",n:"Basic Router",w:10},{id:"dual",n:"Dual Band",w:15},{id:"mesh",n:"Mesh System",w:20}]},
  {id:"charger",n:"Phone Charger",e:"üì±",t:[
    {id:"n5",n:"Normal (5W)",w:5},{id:"f18",n:"Fast (18W)",w:18},{id:"sf65",n:"Super Fast (65W)",w:65}]},
  {id:"cooler",n:"Air Cooler",e:"üå¨Ô∏è",t:[
    {id:"pers",n:"Personal Cooler",w:100},{id:"desert",n:"Desert Cooler",w:200},{id:"tower",n:"Tower Cooler",w:150}]},
  {id:"induction",n:"Induction Cooktop",e:"üç≥",t:[
    {id:"i1200",n:"Induction (1200W)",w:1200},{id:"i1800",n:"Induction (1800W)",w:1800},{id:"i2000",n:"Induction (2000W)",w:2000}]},
  {id:"vacuum",n:"Vacuum Cleaner",e:"üßπ",t:[
    {id:"hand",n:"Handheld",w:200},{id:"can",n:"Canister",w:800},{id:"robot",n:"Robot Vacuum",w:50}]},
];

const HOUSES=[
  {id:"1bhk",n:"1 BHK",d:"Small apartment",e:"üè†"},
  {id:"2bhk",n:"2 BHK",d:"Medium apartment",e:"üè°"},
  {id:"3bhk",n:"3 BHK",d:"Large apartment",e:"üè¢"},
  {id:"indep",n:"Independent",d:"Individual house",e:"üè†"},
  {id:"villa",n:"Villa",d:"Large bungalow",e:"üè∞"},
  {id:"pg",n:"PG / Room",d:"Paying guest",e:"üõèÔ∏è"},
];

const SEASONS=[
  {id:"summer",n:"Summer (Apr-Jun)",m:1.3},{id:"monsoon",n:"Monsoon (Jul-Sep)",m:0.9},
  {id:"winter",n:"Winter (Oct-Jan)",m:0.85},{id:"spring",n:"Spring (Feb-Mar)",m:1.0},
];

const TIPS={
  cool:["Use BLDC fans - save 60% energy vs regular fans","Set AC to 24-26¬∞C - each degree lower increases cost by 6%","Use timer for water heaters - save ‚Çπ500-800/month","Proper insulation reduces cooling costs by 30%","Clean AC filters monthly for 15% better efficiency","Use curtains/blinds to block direct sunlight"],
  light:["LED bulbs use 80% less energy than incandescent","Smart power strips prevent phantom loads","Natural light during day saves ‚Çπ200-400/month","Energy-efficient appliances pay for themselves","Turn off lights when leaving rooms","Use motion sensors for corridors"],
  kitchen:["Use pressure cooker - saves 70% cooking energy","Run fridge at 3-5¬∞C, freezer at -18¬∞C","Don't open fridge door frequently","Use microwave for reheating instead of stove"],
  gen:["Switch off appliances at the wall when not in use","Use 5-star rated appliances for maximum savings","Schedule high-power tasks during off-peak hours","Regular maintenance extends appliance life and efficiency"],
};

let S={house:"2bhk",season:"",rate:5,limit:0,apps:[],nid:1};

// ============================================================
// TNEB CALC
// ============================================================
function tneb(u){
  let rem=u,tot=0,bd=[];
  for(const s of SLABS){
    if(rem<=0)break;
    const su=Math.min(rem,s.mx-s.mn+1);if(su<=0)continue;
    let r=s.r;if(u<=100)r=0;
    bd.push({slab:s.l,units:su,rate:r,amt:su*r});tot+=su*r;rem-=su;
  }
  let cs="Free Tier";
  for(const s of SLABS){if(u>=s.mn&&u<=s.mx){cs=s.l;break;}}
  return{tot,bd,cs};
}

// ============================================================
// AI PREDICTION FROM BACKEND
// ============================================================
async function predictFromAI(appliances) {
  try {
    if (!appliances || !Array.isArray(appliances) || appliances.length === 0) {
      return null;
    }
    const payload = {
      bhk: parseInt(S.house.match(/\d+/) || 2),
      appliances: appliances.map(a => ({watt: a.w, quantity: a.q, hours: a.h}))
    };
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    const response = await fetch('http://localhost:8000/predict', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(payload),
      signal: controller.signal
    });
    clearTimeout(timeoutId);
    if (!response.ok) throw new Error(`API error: ${response.status}`);
    return await response.json();
  } catch (error) {
    console.error('AI prediction failed:', error.message);
    return null;
  }
}

// ============================================================
// INIT
// ============================================================
function init(){
  const hg=document.getElementById('houseGrid');
  hg.innerHTML=HOUSES.map(h=>`<button class="hb ${S.house===h.id?'on':''}" data-id="${h.id}" onclick="selH('${h.id}')"><div class="he">${h.e}</div><div class="hn">${h.n}</div><div class="hi">${h.d}</div></button>`).join('');
  const sa=document.getElementById('sA');
  sa.innerHTML='<option value="">Select appliance</option>'+AP.map(a=>`<option value="${a.id}">${a.e} ${a.n}</option>`).join('');
  const ss=document.getElementById('sS');
  ss.innerHTML='<option value="">Select season</option>'+SEASONS.map(s=>`<option value="${s.id}">${s.n}</option>`).join('');
  calc();
}

function selH(id){
  S.house=id;
  document.querySelectorAll('.hb').forEach(b=>{b.classList.toggle('on',b.dataset.id===id);});
}

function go(name){
  document.querySelectorAll('.tbtn').forEach(b=>{b.classList.remove('on');b.setAttribute('aria-selected','false');});
  document.getElementById('t-'+name).classList.add('on');
  document.getElementById('t-'+name).setAttribute('aria-selected','true');
  document.querySelectorAll('.pan').forEach(p=>p.classList.remove('on'));
  document.getElementById('p-'+name).classList.add('on');
  if(name==='summary'||name==='alerts')calc();
}

function onAC(){
  const aid=document.getElementById('sA').value;
  const ts=document.getElementById('sT');
  const ap=AP.find(a=>a.id===aid);
  if(ap){ts.disabled=false;ts.innerHTML='<option value="">Select type</option>'+ap.t.map(t=>`<option value="${t.id}">${t.n} (${t.w}W)</option>`).join('');}
  else{ts.disabled=true;ts.innerHTML='<option value="">Select type</option>';}
  document.getElementById('bA').disabled=!aid;
}

function addA(){
  const aid=document.getElementById('sA').value;
  const tid=document.getElementById('sT').value;
  if(!aid||!tid)return;
  const ap=AP.find(a=>a.id===aid);const tp=ap.t.find(t=>t.id===tid);
  if(!ap||!tp)return;
  const q=Math.max(1,parseInt(document.getElementById('iQ').value)||1);
  const h=Math.max(0.5,parseFloat(document.getElementById('iH').value)||8);
  S.apps.push({id:S.nid++,aid:ap.id,an:ap.n,tid:tp.id,tn:tp.n,w:tp.w,q,h,e:ap.e});
  document.getElementById('sA').value='';
  document.getElementById('sT').innerHTML='<option value="">Select type</option>';
  document.getElementById('sT').disabled=true;
  document.getElementById('iQ').value='1';document.getElementById('iH').value='8';
  document.getElementById('bA').disabled=true;
  render();calc();
}

function remA(id){S.apps=S.apps.filter(a=>a.id!==id);render();calc();}

function render(){
  const sec=document.getElementById('alSec');
  const emp=document.getElementById('alEmpty');
  if(!S.apps.length){sec.style.display='none';emp.style.display='block';return;}
  sec.style.display='block';emp.style.display='none';
  const dWh=S.apps.reduce((s,a)=>s+a.w*a.q*a.h,0);
  const tQ=S.apps.reduce((s,a)=>s+a.q,0);
  const mKwh=(dWh/1000)*30;
  const mu=Math.round(mKwh);
  const tb=tneb(mu);
  document.getElementById('alSum').textContent=S.apps.length+' appliance(s) ‚Äì Total: '+(dWh/1000).toFixed(2)+' kWh/day';
  document.getElementById('alCnt').textContent=tQ+' items';
  document.getElementById('alDaily').textContent=(dWh/1000).toFixed(2)+' kWh';
  document.getElementById('alMonthly').textContent=mKwh.toFixed(1)+' kWh';
  document.getElementById('alBill').textContent='‚Çπ'+tb.tot.toFixed(2);
  const ls=document.getElementById('alList');
  ls.innerHTML=S.apps.map(a=>{
    const mk=((a.w*a.q*a.h)/1000)*30;
    return`<div class="ai"><div class="aicon">${a.e}</div><div class="ainfo"><div class="nm">${a.an}</div><div class="tp">${a.tn}</div></div><div class="ast hm"><div class="v">${a.w}W</div><div class="l">Watt</div></div><div class="ast"><div class="v">x${a.q}</div><div class="l">Qty</div></div><div class="ast"><div class="v">${a.h}h</div><div class="l">Day</div></div><div class="ast gv"><div class="v">${mk.toFixed(1)}</div><div class="l">kWh/mo</div></div><button class="btn-r" onclick="remA(${a.id})"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg></button></div>`;
  }).join('');
}

function onSC(){
  S.season=document.getElementById('sS').value;
  const inf=document.getElementById('sInfo');
  if(S.season){
    const s=SEASONS.find(x=>x.id===S.season);
    const ds={summer:'Higher usage due to AC and cooling needs',monsoon:'Lower cooling needs, moderate usage',winter:'Lowest cooling needs, water heater usage rises',spring:'Average consumption period'}[S.season];
    inf.style.display='block';inf.innerHTML=`<p>Season multiplier: <strong>${s.m}x</strong></p><p class="sm">${ds}</p>`;
  }else{inf.style.display='none';}
  calc();
}

async function calc(){
  // Early return if no appliances
  if(S.apps.length === 0){
    document.getElementById("sumC").innerHTML = "<div class='cd'><div class='empty'><div class='ei'>‚ö°</div><div class='et'>Add Appliances</div><div class='em'>Add household appliances to calculate consumption and bill.</div></div></div>";
    document.getElementById('altC').innerHTML = "<div class='cd'><h3>Alerts</h3><div class='empty' style='padding:20px;'><div class='ei'>‚ÑπÔ∏è</div><div class='et'>Ready to Start</div><div class='em'>Add appliances to see predictions.</div></div></div>";
    return;
  }

  // Calculate variables
  S.rate = parseFloat(document.getElementById('iR').value) || 5;
  S.limit = parseFloat(document.getElementById('iL').value) || 0;
  const mt = SEASONS.find(s => s.id === S.season)?.m || 1;
  const dWh = S.apps.reduce((s, a) => s + a.w * a.q * a.h, 0);
  const mKwh = (dWh / 1000) * 30 * mt;
  const mu = Math.round(mKwh);
  const tb = tneb(mu);
  const ov = S.limit > 0 && mKwh > S.limit;
  const sd = SEASONS.find(s => s.id === S.season);

  // Get AI prediction
  let aiData = await predictFromAI(S.apps);

  // ‚úÖ Backend status flag (summary-only notice)
  const backendOffline = !aiData;

  let h = '';

  // ‚úÖ Show backend warning only in SUMMARY
  if(backendOffline){
    h += `<div class="cd cd-r">
      <div style="display:flex;align-items:center;gap:12px;padding:20px;">
        <div style="font-size:2rem;">üö®</div>
        <div>
          <div style="font-weight:700;font-size:1rem;color:#991b1b;">AI Backend Disconnected</div>
          <div style="font-size:0.9rem;color:#7c2d12;margin-top:4px;">Showing manual estimate only. Start backend for AI prediction.</div>
          <div style="font-family:monospace;background:#fff;padding:10px;border-radius:8px;margin-top:8px;font-size:0.85rem;color:#dc2626;border:1px solid #fca5a5;">python main.py</div>
        </div>
      </div>
    </div>`;
  }

  // AI Prediction Card
  if(aiData){
    const aiDiff = ((aiData.monthly_units - mKwh) / mKwh * 100).toFixed(1);
    const diffColor = aiDiff > 0 ? '#dc2626' : '#059669';
    const diffIcon = aiDiff > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è';
    h += `<div class="cd" style="border-color:#ddd6fe;background:linear-gradient(135deg,#f5f0ff 0%,#faf8ff 100%);margin-bottom:20px;border:2px solid #a78bfa;">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <span style="font-size:1.2rem;">ü§ñ</span>
        <h3 style="color:#5b21b6;">AI Model Prediction</h3>
      </div>
      <p class="ds" style="color:#7c6a9a;">Neural network trained on real household data</p>
      <div style="margin-top:16px;display:grid;gap:14px;grid-template-columns:1fr 1fr;">
        <div style="padding:16px;border:1px solid #c4b5fd;border-radius:10px;background:#fff;">
          <div style="font-size:.72rem;font-weight:600;color:#5b21b6;text-transform:uppercase;letter-spacing:.5px;">üìä AI Monthly Units</div>
          <div style="font-size:1.3rem;font-weight:800;color:#7c3aed;margin-top:8px;">${Math.max(0, aiData.monthly_units).toFixed(2)} kWh</div>
          <div style="font-size:.75rem;color:#9ca3af;margin-top:4px;">Manual: ${mKwh.toFixed(2)} kWh</div>
        </div>
        <div style="padding:16px;border:1px solid #c4b5fd;border-radius:10px;background:#fff;">
          <div style="font-size:.72rem;font-weight:600;color:#5b21b6;text-transform:uppercase;letter-spacing:.5px;">üí∞ AI Estimated Bill</div>
          <div style="font-size:1.3rem;font-weight:800;color:#7c3aed;margin-top:8px;">‚Çπ${Math.max(aiData.estimated_bill, 1).toFixed(2)}</div>
          <div style="font-size:.75rem;color:${diffColor};margin-top:4px;font-weight:600;">${diffIcon} ${Math.abs(aiDiff)}% ${aiDiff > 0 ? 'higher' : 'lower'}</div>
        </div>
      </div>
    </div>`;
  }

  // Stats Cards
  h += `<div class="g4" style="margin-top:20px;">
    <div class="sc cd-g">
      <div class="tp"><span class="lb">Monthly Consumption</span><span style="font-size:1.2rem;">‚ö°</span></div>
      <div class="vl">${mKwh.toFixed(2)} kWh</div>
      <div class="sb">${(dWh/1000).toFixed(2)} kWh/day</div>
    </div>
    <div class="sc cd-b">
      <div class="tp"><span class="lb">TNEB Bill</span><span style="font-size:1.1rem;">üìà</span></div>
      <div class="vl">‚Çπ${tb.tot.toFixed(2)}</div>
      <div class="sb">${tb.cs}</div>
    </div>
    <div class="sc cd-p">
      <div class="tp"><span class="lb">Season</span><span style="font-size:1.1rem;">üå°Ô∏è</span></div>
      <div class="vl">${S.season ? sd.n.split(' ')[0] : 'Select'}</div>
      <div class="sb">${S.season ? 'Multiplier: ' + mt + 'x' : 'No season'}</div>
    </div>
    <div class="sc ${!S.limit ? 'cd-y' : ov ? 'cd-r' : 'cd-g'}">
      <div class="tp"><span class="lb">Limit Status</span><span style="font-size:1.1rem;">${!S.limit ? '‚ö†Ô∏è' : ov ? 'üö®' : '‚úÖ'}</span></div>
      <div class="vl">${!S.limit ? 'No Limit' : ov ? 'OVER!' : 'OK'}</div>
      <div class="sb">${!S.limit ? 'Unlimited' : ov ? `${(mKwh - S.limit).toFixed(1)} kWh over` : 'Within limit'}</div>
    </div>
  </div>`;

  // TNEB Bill Breakdown
  h += `<div class="cd cd-b" style="margin-top:20px;">
    <h3>TNEB Bill Breakdown</h3>
    <div style="margin-top:14px;">`;
  for(const s of tb.bd) {
    h += `<div class="sr">
      <div><span class="sn">${s.slab}</span></div>
      <span class="sa ${s.rate === 0 ? 'fr' : ''}">${s.rate === 0 ? 'FREE' : '‚Çπ' + s.amt.toFixed(2)}</span>
    </div>`;
  }
  h += `<div class="btb btb-p" style="margin-top:14px;">
    <span class="t">Total TNEB Bill</span>
    <span class="v">‚Çπ${tb.tot.toFixed(2)}</span>
  </div></div></div>`;

  // Appliance Usage
  const sorted = S.apps.map(a => ({...a, mk: ((a.w * a.q * a.h) / 1000) * 30 * mt})).sort((a, b) => b.mk - a.mk);
  h += `<div class="cd"><h3>Appliance Usage Breakdown</h3><div style="margin-top:14px;">`;
  for(const a of sorted) {
    const pc = mKwh > 0 ? (a.mk / mKwh) * 100 : 0;
    h += `<div style="display:flex;align-items:center;gap:12px;padding:12px 16px;border:1px solid var(--g100);border-radius:10px;margin-bottom:8px;">
      <span style="font-size:1.3rem;">${a.e}</span>
      <div style="flex:1;">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
          <span style="font-weight:600;font-size:0.9rem;">${a.an} (x${a.q})</span>
          <span style="color:#7c3aed;font-weight:800;">${a.mk.toFixed(1)} kWh</span>
        </div>
        <div class="pt"><div class="pf" style="width:${pc}%;"></div></div>
      </div>
      <span class="bdg bdg-sm">${pc.toFixed(0)}%</span>
    </div>`;
  }
  h += `</div></div>`;

  // Energy Saving Tips
  h += `<div class="cd cd-g" style="margin-top:20px;">
    <h3 style="color:#065f46;">üí° Energy Saving Tips</h3>
    <div class="tg">`;
  const tsecs = [
    {t:"Cooling", i:"‚ùÑÔ∏è", d:TIPS.cool},
    {t:"Lighting", i:"üí°", d:TIPS.light},
    {t:"Kitchen", i:"üç≥", d:TIPS.kitchen},
    {t:"General", i:"‚öôÔ∏è", d:TIPS.gen}
  ];
  for(const s of tsecs) {
    h += `<div class="ts"><div class="st">${s.i} ${s.t}</div>`;
    for(const t of s.d.slice(0, 2)) h += `<div class="ti"><div class="td"></div><div class="tx">${t}</div></div>`;
    h += `</div>`;
  }
  h += `</div></div>`;
  document.getElementById('sumC').innerHTML = h;

  // ============ ALERTS ============
  const al = [];
  const hC = S.apps.filter(a => ((a.w * a.q * a.h) / 1000) * 30 > 50);
  if(hC.length) al.push({t:'w', ti:'‚ö° High Power Appliances', ms: hC.map(a => a.an).join(', ') + ' use significant energy.'});
  if(S.limit > 0 && mKwh > S.limit) al.push({t:'d', ti:'üö® Limit Exceeded!', ms: `${mKwh.toFixed(1)} kWh exceeds your ${S.limit} kWh limit!`});
  if(mu <= 100 && S.apps.length > 0) al.push({t:'s', ti:'‚úÖ Free Tier!', ms: `${mu} units in free tier (0-100). Bill: ‚Çπ0!`});
  if(tb.tot > 2000) al.push({t:'w', ti:'üí∞ High Bill', ms: `‚Çπ${tb.tot.toFixed(2)} is high. Check energy tips.`});
  if(S.apps.some(a => a.aid === 'ac') && S.season === 'summer') al.push({t:'i', ti:'‚ùÑÔ∏è Summer AC Tip', ms: 'AC uses 40% energy. Set 24-26¬∞C + ceiling fan = 30% savings.'});
  if(!S.season) al.push({t:'i', ti:'üìÖ Season Info', ms: 'Select season for accurate estimates.'});
  if(S.apps.some(a => a.tid === 'inc60' || a.tid === 'inc100' || a.tid === 'crt')) al.push({t:'w', ti:'üî¶ Old Tech', ms: 'Incandescent uses 80% more. Switch to LED!'});
  if(mKwh > 0 && mKwh < 150) al.push({t:'s', ti:'‚úÖ Efficient!', ms: `${mKwh.toFixed(1)} kWh/month is very efficient!`});

  const ic = {d:'üö®', w:'‚ö†Ô∏è', s:'‚úÖ', i:'‚ÑπÔ∏è'};
  const cl = {d:'alt-d', w:'alt-w', s:'alt-s', i:'alt-inf'};
  let ah = `<div class="cd"><h3>Alerts & Recommendations</h3><div style="margin-top:18px;">`;
  if(!al.length) ah += `<div class="empty" style="padding:30px;"><div class="ei">‚úÖ</div><div class="et">All Good!</div><div class="em">Your consumption looks reasonable.</div></div>`;
  else for(const a of al) ah += `<div class="alt ${cl[a.t]}"><div class="alt-i">${ic[a.t]}</div><div><div class="alt-t">${a.ti}</div><p class="alt-m">${a.ms}</p></div></div>`;
  ah += `</div></div>`;
  
  // Quick Stats
  if(S.apps.length > 0) {
    ah += `<div class="cd cd-p" style="margin-top:20px;">
      <h3>Quick Statistics</h3>
      <div class="qg">
        <div class="qb"><div class="ql">Daily Cost</div><div class="qv">‚Çπ${(tb.tot/30).toFixed(2)}</div></div>
        <div class="qb"><div class="ql">Monthly</div><div class="qv">‚Çπ${tb.tot.toFixed(2)}</div></div>
        <div class="qb"><div class="ql">Yearly Est.</div><div class="qv">‚Çπ${(tb.tot*12).toLocaleString('en-IN')}</div></div>
        <div class="qb"><div class="ql">Total Items</div><div class="qv">${S.apps.reduce((s,a) => s+a.q, 0)}</div></div>
        <div class="qb"><div class="ql">Appliances</div><div class="qv">${S.apps.length}</div></div>
        <div class="qb"><div class="ql">Avg Usage</div><div class="qv">${(mKwh/S.apps.length).toFixed(1)} kWh</div></div>
      </div>
    </div>`;
  }

  document.getElementById('altC').innerHTML = ah;
}

function formatAssistantMessage(text){
  const safe = String(text)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");

  return safe
    .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>") // **bold** -> bold
    .replace(/^\s*-\s+/gm, "‚Ä¢ ")                      // dash bullets -> bullet
    .replace(/\n/g, "<br>");                          // new lines
}

document.addEventListener('DOMContentLoaded', init);
</script>

  <!-- ============ AI CHATBOT WIDGET (MUST BE INSIDE BODY) ============ -->
  <div id="chat-widget" style="position:fixed;bottom:16px;right:16px;z-index:9999;font-family:'Inter',sans-serif;">
    <!-- Toggle Button -->
    <button
      id="chat-toggle"
      aria-expanded="false"
      style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg,#7c3aed 0%,#a855f7 100%);color:#fff;border:none;font-size:1.05rem;cursor:pointer;box-shadow:0 2px 10px rgba(124,58,237,0.35);display:flex;align-items:center;justify-content:center;transition:all .2s;padding:0;"
      title="AI Assistant"
      type="button"
    >üí¨</button>

    <!-- Chat Popup -->
    <div
      id="chat-popup"
      style="display:none;position:absolute;bottom:56px;right:0;width:min(92vw,360px);max-height:min(78vh,520px);background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.14);border:1px solid #e5e7eb;overflow:hidden;animation:slideUp .18s ease;z-index:10000;"
      role="dialog"
      aria-label="AI Assistant"
    >
      <div style="background:linear-gradient(135deg,#7c3aed 0%,#a855f7 100%);color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-size:1.05rem;">ü§ñ</span>
          <div>
            <div style="font-weight:800;font-size:0.9rem;line-height:1;">AI Assistant</div>
            <div style="font-size:0.7rem;opacity:0.85;margin-top:2px;">Energy saver tips</div>
          </div>
        </div>
        <button id="close-chat" type="button" style="background:none;border:none;color:#fff;cursor:pointer;font-size:1.1rem;padding:2px 6px;">‚úï</button>
      </div>

      <div id="chat-messages" style="height:min(50vh,320px);overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px;background:#f9fafb;">
        <div style="display:flex;gap:8px;align-items:flex-start;">
          <div style="width:28px;height:28px;border-radius:50%;background:#e9d5ff;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.95rem;">ü§ñ</div>
          <div style="background:#fff;padding:10px 12px;border-radius:10px;max-width:250px;border:1px solid #e5e7eb;font-size:0.85rem;line-height:1.45;color:#374151;">
            Hey there! Ask me for electricity saving tips or efficient device suggestions.
          </div>
        </div>
      </div>

      <div style="padding:12px;border-top:1px solid #e5e7eb;display:flex;gap:8px;background:#fff;">
        <input id="chat-input" type="text" placeholder="Type a question..." style="flex:1;padding:9px 10px;border:1.5px solid #d1d5db;border-radius:8px;font-size:0.85rem;outline:none;font-family:inherit;background:#f9fafb;" />
        <button id="send-chat" type="button" style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff;border:none;padding:9px 12px;border-radius:8px;cursor:pointer;font-weight:800;font-size:0.85rem;min-width:42px;">‚Üë</button>
      </div>
    </div>
  </div>

  <style>
    @keyframes slideUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    #chat-toggle:hover { transform: scale(1.06); }
    #chat-toggle:active { transform: scale(0.96); }
    #chat-input:focus { border-color:#7c3aed; background:#fff; box-shadow: 0 0 0 3px rgba(124,58,237,0.10); }
    #chat-messages::-webkit-scrollbar { width: 6px; }
    #chat-messages::-webkit-scrollbar-thumb { background: #c4b5fd; border-radius: 10px; }
  </style>

  <style>
    /* Responsive AI assistant */
    #chat-widget{
      right:max(12px, env(safe-area-inset-right));
      bottom:max(12px, env(safe-area-inset-bottom));
    }

    #chat-popup{
      width:min(92vw, 360px) !important;
      max-height:min(78vh, 520px) !important;
    }

    #chat-messages{
      height:min(50vh, 320px) !important;
    }

    @media (max-width: 480px){
      #chat-toggle{
        width:44px !important;
        height:44px !important;
        font-size:1rem !important;
      }

      #chat-popup{
        right:0 !important;
        width:calc(100vw - 24px) !important;
        max-height:74vh !important;
      }

      #chat-messages{
        height:42vh !important;
      }
    }
  </style>

  <script>
    // Chat widget init (no DOMContentLoaded needed since this is at end of body)
    (function initChatWidget(){
      const chatWidget = document.getElementById('chat-widget');
      const chatToggle = document.getElementById('chat-toggle');
      const chatPopup = document.getElementById('chat-popup');
      const closeChat = document.getElementById('close-chat');
      const chatMessages = document.getElementById('chat-messages');
      const chatInput = document.getElementById('chat-input');
      const sendChat = document.getElementById('send-chat');

      if(!chatWidget || !chatToggle || !chatPopup || !closeChat || !chatMessages || !chatInput || !sendChat) return;

      let chatOpen = false;

      function setOpen(open){
        chatOpen = !!open;
        chatPopup.style.display = chatOpen ? 'block' : 'none';
        chatToggle.setAttribute('aria-expanded', chatOpen ? 'true' : 'false');
        if(chatOpen){
          chatInput.focus();
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      }

      chatToggle.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        setOpen(!chatOpen);
      });

      closeChat.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        setOpen(false);
      });

      // click outside closes
      document.addEventListener('click', (e) => {
        if(!chatOpen) return;
        if(!chatWidget.contains(e.target)) setOpen(false);
      });

      // ESC closes
      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') setOpen(false);
      });

      async function sendChatMessage(){
        const message = chatInput.value.trim();
        if(!message) return;

        const userDiv = document.createElement('div');
        userDiv.style.cssText = 'display:flex;gap:8px;justify-content:flex-end;align-items:flex-start;';
        userDiv.innerHTML = `<div style="background:linear-gradient(135deg,#7c3aed,#a855f7);color:#fff;padding:10px 12px;border-radius:10px;max-width:250px;font-size:0.85rem;line-height:1.45;word-wrap:break-word;">${message}</div>`;
        chatMessages.appendChild(userDiv);
        chatInput.value = '';
        chatMessages.scrollTop = chatMessages.scrollHeight;

        const typingDiv = document.createElement('div');
        typingDiv.style.cssText = 'display:flex;gap:8px;align-items:flex-start;';
        typingDiv.innerHTML = `<div style="width:28px;height:28px;border-radius:50%;background:#e9d5ff;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.95rem;">ü§ñ</div>
          <div style="background:#fff;padding:10px 12px;border-radius:10px;max-width:250px;border:1px solid #e5e7eb;font-size:0.85rem;">Thinking‚Ä¶</div>`;
        chatMessages.appendChild(typingDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        try{
          // IMPORTANT: call your backend (do NOT call Azure OpenAI directly from browser)
          const resp = await fetch('http://localhost:8000/chat', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ message })
          });

          typingDiv.remove();

          if(!resp.ok) throw new Error(`Chat API error: ${resp.status}`);
          const data = await resp.json();
          const reply = (data && data.reply) ? String(data.reply) : 'Sorry, I could not generate a reply.';

          const botDiv = document.createElement('div');
          botDiv.style.cssText = 'display:flex;gap:8px;align-items:flex-start;';
          botDiv.innerHTML = `
            <div style="width:28px;height:28px;border-radius:50%;background:#e9d5ff;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.95rem;">ü§ñ</div>
            <div style="background:#fff;padding:10px 12px;border-radius:10px;max-width:250px;border:1px solid #e5e7eb;font-size:0.85rem;line-height:1.45;color:#374151;word-wrap:break-word;">
              ${formatAssistantMessage(reply)}
            </div>
          `;
          chatMessages.appendChild(botDiv);
        }catch(err){
          typingDiv.remove();
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = 'display:flex;gap:8px;align-items:flex-start;';
          errorDiv.innerHTML = `<div style="width:28px;height:28px;border-radius:50%;background:#e9d5ff;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:0.95rem;">ü§ñ</div>
            <div style="background:#fff;padding:10px 12px;border-radius:10px;max-width:250px;border:1px solid #fca5a5;font-size:0.85rem;color:#991b1b;">Backend chat is offline. Start the backend and try again.</div>`;
          chatMessages.appendChild(errorDiv);
        }

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      sendChat.addEventListener('click', sendChatMessage);
      chatInput.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          sendChatMessage();
        }
      });

      setOpen(false);
    })();
  </script>

  <!-- PWA: Service Worker registration -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", async () => {
        try {
          await navigator.serviceWorker.register("./sw.js");
          console.log("‚úÖ Service Worker registered");
        } catch (e) {
          console.warn("SW registration failed:", e);
        }
      });
    }
  </script>
</body>
</html>
